# ๐นโ๐ท ุงูุงุณุชุฑุฌุงุน ูู ุงูุตุบูุฑ ูููุจูุฑ โพ๏ธ โ โฌ๏ธ

<div dir="rtl">

ููููู ุงูุงุณุชุฑุฌุงุน ูู ุงูุตุบูุฑ ูููุจูุฑุ ุฃู ุงููู ูุนุฑูู ููุงู ุจุงูุงุณุชุฑุฌุงุน ุงูุชูุฑุงุฑูุ ุฌุฒุก ุฃุณุงุณู ูู LlamaIndex. ูุนุดุงู ูุณุชุฎุฏู ุฏูุ ูุงุฒู ูุนุฑู ุฅุฒุงู ูุณุชุฑุฌุน ุงูุณูุงู ุฐู ุงูุตูุฉ ูู ุงูููุฑุณ ุจููุงุกุฉ ุจูุงุกู ุนูู ุงูุงุณุชุนูุงู. ุฏู ูุนูุงู ุชุญุฏูุฏ ุงุณุชุฑุงุชูุฌูุฉ ุงุณุชุฑุฌุงุน ุชูุฑุงุฑูุฉุ ูุนุงูุฌุฉ ุงูุนูุฏ ุจุนุฏ ุงุณุชุฑุฌุงุนูุง ูุชูููู ุงูุงุณุชุฌุงุจุงุช.

1) ๐ **ุงูุงุณุชุฑุฌุงุน ุงูุชูุฑุงุฑู**

   - **ุงููุทุน ุงูุตุบูุฑุฉ (ุงููุทุน ุงูุฃุทูุงู)**: ูู ุงูุจุฏุงูุฉ ุจุชุณุชุฑุฌุน ูุทุน ุจูุงูุงุช ุฃุตุบุฑ ูุฎุงุตุฉ ุจุงูุงุณุชุนูุงู.
   
   - **ุงููุทุน ุงููุจูุฑุฉ (ุงููุทุน ุงูุขุจุงุก)**: ุจุชุชุจุน ุงููุฑุงุฌุน ูููุทุน ุงูุฃูุจุฑ ุงููู ุนูุฏูุง ุณูุงู ูุฑุชุจุท ุจุงููุทุน ุงูุฃุตุบุฑ. ุจุชุญุชูุธ ุจุงูุณูุงู ุฏุงุฎู ูู ูุทุนุฉ.

2) ๐๏ธ **ูุนุงูุฌุฉ ุงูุนูุฏ ุจุนุฏ ุงูุงุณุชุฑุฌุงุน:** ุชุทุจูู ุชุญูููุงุชุ ุชุตููุฉุ ุฃู ุฅุนุงุฏุฉ ุชุฑุชูุจ ููุนูุฏ ุงููุณุชูุฑุฌุนุฉ ูุชุญุณูู ุฌูุฏุฉ ุงูุจูุงูุงุช ูุงูููุงุกูุฉ.

3) ๐ **ููุฑูููุจ ุงูุงุณุชุฌุงุจุฉ:** ุงุณุชุฎุฏุงู ูุทุน ุงููุต ุงููุณุชูุฑุฌุนุฉ ูุน ุงุณุชุนูุงู ุงููุณุชุฎุฏู ูุชูููุฏ ุงุณุชุฌุงุจุฉ.

## ๐ช [`SentenceWindowNodeParser`](https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/node_parser/text/sentence_window.py)

ุงูู `SentenceWindowNodeParser` ูุฑูุฏ ูู ููุนู ูู ุฅูู ุจูุฑูุฒ ุนูู ุงูุฌูู ุงููุฑุฏูุฉ ููู ููุณ ุงูููุช ุจููุชูุท ุงูุณูุงู ุงููุญูุท. ุฏู ูููุฏ ุจุดูู ุฎุงุต ููููุงู ุงููู ููู ุงูุณูุงู ุงูุฃูุณุน ููุฌููุฉ ุจูููู ูููุฏ.

### ุฅุฒุงู ุจูุดุชุบู

1. **ุชูุณูู ุงูุฌูู:**

   * ุฒู `SentenceSplitter`ุ ุจููุณู ุงููุณุชูุฏ ุงูุฃูู ูุฌูู ูุฑุฏูุฉ ุจุงุณุชุฎุฏุงู ูุญูู ุฑููุฒ ุฌูู (ุงูุชุฑุงุถูุงู [`PunktSentenceTokenizer`](https://www.nltk.org/api/nltk.tokenize.PunktSentenceTokenizer.html) ูู ููุชุจุฉ `nltk`).

2. **ุฅูุดุงุก ุงููุงูุฐุฉ:**

   * ููู ุฌููุฉ (ุนูุฏุฉ)ุ ุจูุฌูุน "ูุงูุฐุฉ" ูู ุงูุฌูู ุงููุญูุทุฉ ุจูุงุกู ุนูู `window_size` ุงููุญุฏุฏ.
   
   * ุงููุงูุฐุฉ ุฏู ุจุชุชุฎุฒู ูู ุงูุจูุงูุงุช ุงููุตููุฉ ููุนูุฏุฉ ุชุญุช `window_metadata_key`.

3. **ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุงููุตููุฉ:**

   * ูุต ุงูุฌููุฉ ุงูุฃุตูู ููุงู ุจูุชุฎุฒู ูู ุงูุจูุงูุงุช ุงููุตููุฉ ุชุญุช `original_text_metadata_key`.
   
   * ูุงููููุ ุงููุงูุฐุฉ ูุงููุต ุงูุฃุตูู ููุงููุง ุจูุชู ุงุณุชุจุนุงุฏูู ูู ุฑุคูุฉ ูููุฐุฌ ุงูุชุถููู ูุงูู LLM.

### ูุนุงููุงุช ูุงุฒู ุชุนุฑููุง

* **`window_size`**: ุจูุชุญูู ูู ุนุฏุฏ ุงูุฌูู ุงููุฑุงุฏ ุชุถููููุง ูุจู ูุจุนุฏ ุงูุฌููุฉ ุงููุฑูุฒูุฉ ูู ุงููุงูุฐุฉ.

* **`window_metadata_key`**: ุงูููุชุงุญ ุงููุณุชุฎุฏู ูุชุฎุฒูู ูุต ุงููุงูุฐุฉ ูู ุงูุจูุงูุงุช ุงููุตููุฉ ููุนูุฏุฉ.

* **`original_text_metadata_key`**: ุงูููุชุงุญ ุงููุณุชุฎุฏู ูุชุฎุฒูู ูุต ุงูุฌููุฉ ุงูุฃุตูู ูู ุงูุจูุงูุงุช ุงููุตููุฉ.

* **`sentence_splitter`**: ููุณู ุงููุต ุงููุณุชุฎุฏู ุนูุฏ ุชูุณูู ุงููุณุชูุฏุงุช (ุงูุชุฑุงุถูุงู [`PunktSentenceTokenizer`](https://www.nltk.org/api/nltk.tokenize.PunktSentenceTokenizer.html) ูู ููุชุจุฉ `nltk`).

### ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู

```python
from llama_index.core.node_parser import SentenceWindowNodeParser

parser = SentenceWindowNodeParser(window_size=2)

nodes = parser.get_nodes_from_documents(documents)
```

### ุงูุชู ุชุณุชุฎุฏู `SentenceWindowNodeParser`

* **ุงูููุงู ุงููู ุจุชุญุชุงุฌ ููู ุนูู ูุณุชูู ุงูุฌููุฉ ูุน ุงูุณูุงู:**
  * ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉุ ุงูุชูุฎูุตุ ุฃู ุชุญููู ุงููุดุงุนุฑ ุญูุซ ุงูุฌูู ุงููุญูุทุฉ ุจุชููุฑ ุณูุงู ููู.

* **ุชุญูู ุฏููู ูู ูุทุงู ุงูุชุถููู:**
  * ุฅูุดุงุก ุชุถูููุงุช ุจุชุฑูุฒ ุนูู ุงููุนูู ุงููุญุฏุฏ ููุฌููุฉ ุถูู ุณูุงููุง ุงููุญูู.

* **ุงูุฏูุฌ ูุน MetadataReplacementNodePostProcessor:**
  * ุงุณุชุจุฏุงู ุงูุฌููุฉ ุงูุฃุตููุฉ ุจุงููุงูุฐุฉ ุงููุญูุทุฉ ุจูุง ูุจู ุฅุฑุณุงููุง ููู LLMุ ููุง ูุณูุญ ูููููุฐุฌ ุจุงููุธุฑ ูู ุงูุณูุงู ุงูุฃูุณุน.

### ููุฏ ุงูุชุทุจูู

```python
senpai_documents[42].__dict__
```

```python
from llama_index.core.node_parser import SentenceWindowNodeParser

example_parsed = SentenceWindowNodeParser(window_size=2).build_window_nodes_from_documents([senpai_documents[42]])
```

```python
example_parsed[3].__dict__
```

```python
example_parsed_2 = SentenceWindowNodeParser(window_size=3).get_nodes_from_documents([senpai_documents[42]])
```

```python
example_parsed_2[3].__dict__
```

## ๐ ููู `MetadataReplacementPostProcessor` ู `SentenceWindowNodeParser`

- ๐ **ูุฑุงุฌุนุฉ `SentenceWindowNodeParser`**

  - **ุชุญููู ุฌููุฉ ูุงุญุฏุฉ**: ุจูุญูู ุงููุณุชูุฏุงุช ูุนูุฏุ ูู ูุงุญุฏุฉ ุจุชุญุชูู ุนูู ุฌููุฉ ูุงุญุฏุฉ.
  
  - **ูุงูุฐุฉ ุณูุงููุฉ**: ูู ุนูุฏุฉ ุจุชุชุถูู "ูุงูุฐุฉ" ูู ุงูุฌูู ุงููุญูุทุฉ ุจุงูุฌููุฉ ุงูุฃุณุงุณูุฉ ูุณูุงู ุฅุถุงูู.

- ๐ **[`MetadataReplacementPostProcessor`](https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/postprocessor/metadata_replacement.py)**

  - **ุชุญุณูู ุงูุณูุงู**: ุจูุณุชุจุฏู ุงูุฌููุฉ ูู ูู ุนูุฏุฉ ุจูุงูุฐุฉ ุงูุฌูู ุงููุญูุทุฉ ุจูุง ุฎูุงู ุงูุงุณุชุฑุฌุงุน.
  
  - **ููุณุชุฎุฏู ุจุงูุชุฒุงูู**: ุบุงูุจุงู ุจูุชูุฑู ูุน `SentenceWindowNodeParser` ูุชุนุธูู ุงูุจูุงูุงุช ุงูุณูุงููุฉ ุงูููุฏูุฉ ููู LLM.

### ุนูููุฉ ุงูุงุณุชุนูุงู ูุงูุงุณุชุฌุงุจุฉ

- ๐ **ูุนุงูุฌุฉ ุงูุงุณุชุนูุงู**

  - **ุงุณุชุฑุฌุงุน ุงูุฌูู**: ุจูุณุชุฑุฌุน ุฃูุชุฑ ุงูุฌูู ุฐุงุช ุตูุฉ ุจูุงุกู ุนูู ุงูุงุณุชุนูุงู.
  
  - **ุญูู ุงูุณูุงู**: ุจุฏูุงู ูู ูุฌุฑุฏ ุฅุฑุฌุงุน ุงูุฌูู ุฏูุ ุงููุนุงูุฌ ุงููุงุญู ุจูุญูู ุงูุณูุงู ุงููุญูุท ูู ุงููุงูุฐุฉ.

- ๐ **ููุงุฆุฏ ุงูุณูุงู ุงููุญุณูู**

  - **ููู ูุญุณูู**: ุณูุงู ุฃูุชุฑ ุจูุณุงุนุฏ ุงูู LLM ูููู ุงูุงุณุชุนูุงูุงุช ุจุดูู ุฃุญุณูุ ููุง ูุคุฏู ูุงุณุชุฌุงุจุงุช ุฃุฏู.
  
  - **ุงุณุชุฌุงุจุงุช ููุตูุฉ**: ุงูุณูุงู ุงูุฅุถุงูู ุจูุณูุญ ุจุงุณุชุฌุงุจุงุช ููุตูุฉ ูุฐุงุช ุตูุฉ.

- ๐ **ูุซุงูู ูููุณุชูุฏุงุช ุงููุจูุฑุฉ**

  - **ุงุณุชุฑุฌุงุน ุฏููู**: ูููุฏ ุจุดูู ุฎุงุต ูููุณุชูุฏุงุช ุงููุจูุฑุฉ ุฃู ุงูููุงุฑุณุ ููุง ูุชูุญ ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุฃูุชุฑ ุฏูุฉ.

<img src="https://miro.medium.com/v2/resize:fit:2000/0*JKZ9m_c6jyIKqCWu.png">

ูุตุฏุฑ ุงูุตูุฑุฉ: [Ivan Ilin](https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6)

### ููุฏ ุงูุชุทุจูู

```python
from llama_index.core.node_parser import SentenceWindowNodeParser

def sentence_window_splitter(window_size, documents):
    splitter = SentenceWindowNodeParser(
        window_size=window_size,
        window_metadata_key="window_size",
        original_text_metadata_key="original_text",
    )
    nodes = splitter.get_nodes_from_documents(documents)
    return nodes
```

```python
nodes = sentence_window_splitter(window_size=5, documents=senpai_documents)
```

```python
nodes[5].__dict__
```

```python
print(nodes[5].get_content(metadata_mode="all"))
```

```python
print(nodes[5].get_content(metadata_mode="llm"))
```

## ๐ท๐ฝโโ๏ธ ๐๏ธ ุงูุฅุฏุฎุงู ูู Qdrant ูุจูุงุก ุงูููุฑุณ

```python
from llama_index.core import StorageContext
from llama_index.core.settings import Settings

from utils import create_index, create_query_engine
from utils import setup_vector_store

COLLECTION_NAME = "wots-small-to-big-sentence-window"

sentence_window_vector_store = setup_vector_store(QDRANT_URL, QDRANT_API_KEY, COLLECTION_NAME)
```

```python
from utils import ingest

transforms = [Settings.embed_model]

split_nodes = ingest(
    documents=nodes,
    transformations=transforms,
    vector_store=sentence_window_vector_store
)
```

### ๐๏ธ ุฅุนุฏุงุฏ ูุญุฑู ุงูุงุณุชุนูุงู

```python
from llama_index.core import PromptTemplate
from llama_index.core.postprocessor import MetadataReplacementPostProcessor

from utils import create_query_engine
from prompts import HYPE_ANSWER_GEN_PROMPT

HYPE_ANSWER_GEN_PROMPT_TEMPLATE = PromptTemplate(HYPE_ANSWER_GEN_PROMPT)

node_postprocessors = [MetadataReplacementPostProcessor(target_metadata_key="window")]

sentence_window_index = create_index(
    from_where="vector_store",
    vector_store=sentence_window_vector_store,
    embed_model=Settings.embed_model,
)

sentence_window_query_engine = create_query_engine(
    index=sentence_window_index, 
    mode="query",
    response_mode="compact",
    similiarty_top_k=5,
    vector_store_query_mode="mmr", 
    vector_store_kwargs={"mmr_threshold": 0.42},
    node_postprocessors=node_postprocessors
)

sentence_window_query_engine.update_prompts({'response_synthesizer:text_qa_template': HYPE_ANSWER_GEN_PROMPT_TEMPLATE})
```

### ๐ง ุฅุนุฏุงุฏ ุฎุท ุฃูุงุจูุจ ุงูุงุณุชุนูุงู

```python
from utils import create_query_pipeline
from llama_index.core.query_pipeline import InputComponent

input_component = InputComponent()

sentence_window_chain = [input_component, sentence_window_query_engine]

sentence_window_query_pipeline = create_query_pipeline(sentence_window_chain)
```

```python
sentence_window_query_pipeline.run(input="ุฅุฒุงู ุฃูุฏุฑ ุฃุจูู ููุฉ ุจุดูู ูุนุงู ูู ุฌูุงูุจ ูุชุนุฏุฏุฉ ูู ุงูุญูุงุฉ ุงูุญููููุฉ ูู ุบูุฑ ูุง ุฃุนุชูุฏ ุนูู ุขูุงุช ูุนูุฏุฉุ")
```

```python
sentence_window_query_pipeline.run(input="ุฅุฒุงู ุฃูุฏุฑ ุฃุญุท ููุงุนุฏ ูุฃุชููู ุจุตุฑุงุญุฉ ูู ุบูุฑ ูุง ุฃููู ุนูู ุฌุฑุญ ูุดุงุนุฑ ุญุฏุ")
```

## ๐จโ๐ฆ ุงููุทุน ุงูุฃุทูุงู ุงูุฃุตุบุฑ ุจุชุดูุฑ ูููุทุนุฉ ุงูุฃุจ ุงูุฃูุจุฑ

<img src="https://miro.medium.com/v2/resize:fit:2000/0*x4rMd50GP99OSDuo.png" width="70%">

ุงููุตุฏุฑ: [Ivan Ilin](https://pub.towardsai.net/advanced-rag-techniques-an-illustrated-overview-04d193d8fec6)

๐ **ุดุฑุญ ูุฑุงุฌุน ุงููุทุน:**

- ๐งฉ **ุงูููููู**: ูุฑุงุฌุน ุงููุทุน ุจุชุชุถูู ูุทุน ุจูุงูุงุช ุฃุตุบุฑ ุจุชุดูุฑ ููุทุน ุฃุจ ุฃูุจุฑุ ููููุฉ ุจููุฉ ุฑุณู ุจูุงูู ูุฑููุฉ.

- ๐ **ุงููุฏู**: ุงูุทุฑููุฉ ุฏู ุจุชูุณุชุฎุฏู ูู ุงูุงุณุชุฑุฌุงุน ุงูุชูุฑุงุฑู ูุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ูุงููุตูู ูููุง ุจููุงุกุฉ ุจุทุฑููุฉ ููุธูุฉ.

### ุงูุนูููุฉ ุฎูุงู ุงูุงุณุชุนูุงู

- ๐ **ุฎูุงู ููุช ุงูุงุณุชุนูุงู**:

  - **ุงุณุชุฑุฌุงุน ุงููุทุนุฉ ุงูุตุบูุฑุฉ**: ูู ุงูุจุฏุงูุฉุ ุจูุชู ุงุณุชุฑุฌุงุน ุงููุทุน ุงูุฃุตุบุฑ ุฐุงุช ุงูุตูุฉ ุจุงูุงุณุชุนูุงู.
  
  - **ูุชุงุจุนุฉ ุงููุฑุงุฌุน**: ุงููุธุงู ุจุนุฏูู ุจูุชุจุน ุงููุฑุงุฌุน ูุงุณุชุฑุฌุงุน ุงููุทุน ุงูุฃุจ ุงูุฃูุจุฑ ุงููุฑุชุจุทุฉ ุจุงููุทุน ุงูุฃุตุบุฑ ุฏู.

- ๐ **ููุงุฆุฏ ุงูุงุณุชุฑุฌุงุน ุงูุณูุงูู**:

  - **ุณูุงู ูุญุณูู**: ุงุณุชุฑุฌุงุน ุงููุทุน ุงูุฃูุจุฑ ูุน ุงูุฃุตุบุฑ ุจูููุฑ ุณูุงู ุฅุถุงูู.
  
  - **ุงุณุชุฌุงุจุงุช ูุญุณููุฉ**: ุงูุณูุงู ุงูุฃุนูู ุฏู ุจูุณูุญ ุจุงุณุชุฌุงุจุงุช ุฃุฏู ูุฃูุซุฑ ุดูููุงู ููุงุณุชุนูุงูุงุช.

ุงููููุฌ ุงูููุธู ุฏู ุจูุถูู ุฅู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ูููู ููุก ูุบูู ุจุงูุณูุงูุ ููุง ุจูุญุณู ุงูุชุฑููุจ ุงูููู ูุฏูุฉ ุงูุงุณุชุฌุงุจุฉ.

ุงูููุฏ ุงููู ุชุญุช ุจููุดุฆ ูุธุงู ุญูุซ ุงููุทุน ุงูุฃุตุบุฑ ูู ุงููุต ุจุชุดูุฑ ูููุทุน ุงูุฃูุจุฑ ุงููู ุงุชุนููุช ูููุง. ุฏู ุจูุณูุญ ุจุชูููุฑ ุณูุงู ุฃูุชุฑ ููุง ูุณุชุฑุฌุน ูุทุน ุงููุต ุจูุงุกู ุนูู ุงุณุชุนูุงู.

```python
# ุงุณุชูุฑุงุฏ ููุงุณ SentenceSplitter ูู ูุญุฏุฉ llama_index.core.node_parser
from llama_index.core.node_parser import SentenceSplitter
from llama_index.core.schema import IndexNode

# ุชุญุฏูุฏ ุฃุญุฌุงู ุงููุทุน ูุชูุณูู ุงูุฌูู
sub_chunk_sizes = [128, 256, 512]

# ุฅูุดุงุก ูุงุฆูุฉ ูู ููุงุฐุฌ SentenceSplitter ุจุฃุญุฌุงู ูุทุน ูุฎุชููุฉ
sub_node_parsers = [SentenceSplitter(chunk_size=c, chunk_overlap=16) for c in sub_chunk_sizes]

# ุชููุฆุฉ ูุงุฆูุฉ ูุงุฑุบุฉ ูุชุฎุฒูู ุฌููุน ุนูุฏ ุงูููุฑุณ
all_nodes = []

# ุงูุชูุฑุงุฑ ุนูู ูู ุนูุฏุฉ ุฃุณุงุณูุฉ ูู senpai_documents
for base_node in senpai_documents:
    # ูุนุงูุฌุฉ ูู ุนูุฏุฉ ุฃุณุงุณูุฉ ุจูู SentenceSplitter ูู ุงููุงุฆูุฉ
    for n in sub_node_parsers:
        # ุงูุญุตูู ุนูู ุงูุนูุฏ ุงููุฑุนูุฉ ุนู ุทุฑูู ุชูุณูู ูุณุชูุฏ ุงูุนูุฏุฉ ุงูุฃุณุงุณูุฉ ูุฃุฌุฒุงุก ุฃุตุบุฑ
        sub_nodes = n.get_nodes_from_documents([base_node])
        # ุชุญููู ูู ุนูุฏุฉ ูุฑุนูุฉ ูู IndexNode ูุฑุจุทูุง ุจูุนุฑู ุงูุนูุฏุฉ ุงูุฃุณุงุณูุฉ
        sub_inodes = [
            IndexNode.from_text_node(sn, base_node.node_id) for sn in sub_nodes
        ]
        # ุฅุถุงูุฉ ุนูุฏ ุงูููุฑุณ ุงูููุดุฃุฉ ุญุฏูุซุงู ููุงุฆูุฉ all_nodes
        all_nodes.extend(sub_inodes)

    # ุฅุถุงูุฉ ุงูุนูุฏุฉ ุงูุฃุณุงุณูุฉ ุงูุฃุตููุฉ ููุงู ููุงุฆูุฉ ุฌููุน ุงูุนูุฏ ูู IndexNode
    original_node = IndexNode.from_text_node(base_node, base_node.node_id)
    all_nodes.append(original_node)
```

```python
all_nodes_dict = {n.node_id: n for n in all_nodes}
```

```python
all_nodes[5].__dict__
```

### ๐ท๐ฝโโ๏ธ ๐๏ธ ุงูุฅุฏุฎุงู ูู Qdrant ูุจูุงุก ุงูููุฑุณ

```python
from utils import ingest

COLLECTION_NAME = "words-of-the-senpai-small-to-big-parent-child"

parent_child_vector_store = setup_vector_store(QDRANT_URL, QDRANT_API_KEY, COLLECTION_NAME)

transforms = [Settings.embed_model]

parent_child_nodes = ingest(
    documents=all_nodes,
    transformations=transforms,
    vector_store=parent_child_vector_store
)

parent_child_index = create_index(
    from_where="vector_store", 
    embed_model=Settings.embed_model,
    vector_store=parent_child_vector_store)
```

### ๐๏ธ ุฅุนุฏุงุฏ ูุญุฑู ุงูุงุณุชุนูุงู ููุทุน ุงูุฃุจ ูุงูุทูู

ุจูุณุชุฎุฏู `RecursiveRetriever` ู `RetrieverQueryEngine`.

`RecursiveRetriever` ููุงุณ ูููุตู ูุด ูุฑุชุจุท ูุจุงุดุฑุฉ ุจููุฑุณ. ุจูุณุชุฎุฏู ุนุฏุฉ ูุณุชูุฑุฌุนุงุช ููุญุฑูุงุช ุงุณุชุนูุงู ูุงุณุชุฑุฌุงุน ูุงุณุชุนูุงู ุงูุนูุฏ ุจุดูู ุชูุฑุงุฑู.

ุจุณุ ูุด ููุฏุฑ ูุณุชุฎุฏู `RecursiveRetriever` ูุจุงุดุฑุฉ ูุน ููุท `index.as_retriever()` ุงููู ุดููุงู ูุจู ูุฏู. ููุท `index.as_retriever()` ุจููุณุชุฎุฏู ูุฅูุดุงุก ูุณุชูุฑุฌุน ูู ููุฑุณุ ูููุน ุงููุณุชูุฑุฌุน ุงููู ุจููุดุฆู ุจูุนุชูุฏ ุนูู ูุนุงูู `retriever_mode` ุงููู ุจุชูุฑุฑู ููู. `RecursiveRetriever` ุจูุญุชุงุฌ ูุงููุณ ูู ุงููุณุชูุฑุฌุนุงุชุ ูุงุฎุชูุงุฑูุงู ูุงููุณ ูู ูุญุฑูุงุช ุงูุงุณุชุนูุงู ููุงููุณ ูู ุงูุนูุฏ. ุฏูู ูุด ูุทููุจูู ููุง ุชูุดุฆ ูุณุชูุฑุฌุน ุจุงุณุชุฎุฏุงู `index.as_retriever()`.

ุนูุดุงู ูุฏูุ ูุงุฒู ูุจูู `RecursiveRetriever` ู `RetrieverQueryEngine` ูุฅูุฌุงุฒ ุฏู.

- `RecursiveRetriever` ุจูุณุชุนูู ุฑุณู ุจูุงูู ูู ุงููุณุชูุฑุฌุนุงุช ููุญุฑูุงุช ุงูุงุณุชุนูุงูุ ุจูุชุจุน ุงูุฑูุงุจุท ุจูููู ูุฌูุจ ุงููุนูููุงุช ุฐุงุช ุงูุตูุฉ ูุงุณุชุนูุงู ูุนูู. ุจูุนุจุฑ ุงูุฑุณู ุงูุจูุงูู ุจุดูู ุชูุฑุงุฑูุ ุจูุฒูู ุงูุชูุฑุงุฑ ูู ุงูุนูุฏุ ูุจูุฑุฌุน ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ ูุน ุฃู ุนูุฏ ูุตุฏุฑ ุฅุถุงููุฉ.

- `RetrieverQueryEngine` ูููู ุจูุณุชุฎุฏู ูุณุชูุฑุฌุน ูุฌูุจ ุงููุณุชูุฏุงุช ุฃู ุงูุนูุฏ ุฐุงุช ุงูุตูุฉ ุจูุงุกู ุนูู ุงุณุชุนูุงู ูุนูู ูุจุนุฏูู *ุจููุฑูุจ ุงุณุชุฌุงุจุฉ ูู ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ ุจุงุณุชุฎุฏุงู `ResponseSynthesizer`*. ุจูุณุชุฑุฌุน ุงูุนูุฏ ุฐุงุช ุงูุตูุฉุ ุจูุทุจู ูุนุงูุฌุฉ ูุงุญูุฉุ ุจููุฑูุจ ุงุณุชุฌุงุจุฉุ ูุจูุฑุฌุน ุงููุชูุฌุฉ.

ุชูุงุตูู ุฃูุชุฑ ุชุญุช.

#### [`RecursiveRetriever`](https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/retrievers/recursive_retriever.py)

##### ๐ฟ ุงูุชููุฆุฉ

- ูุงุฎุฏ ูุนุฑู ุฌุฐุฑุ ูุงููุณ ูุณุชูุฑุฌุนุงุชุ ูููุงููุณ ุงุฎุชูุงุฑูุฉ ููุญุฑูุงุช ุงูุงุณุชุนูุงู ูุงูุนูุฏ
- ูุชุญูู ูู ูุนุฑู ุงูุฌุฐุฑ ูููุญุต ุงูููุงุชูุญ ุงููุชุฏุงุฎูุฉ

##### ๐ ุงูุงุณุชุฑุฌุงุน ุงูุชูุฑุงุฑู

- ูุจุฏุฃ ูู ูุนุฑู ุงูุฌุฐุฑ ููุง ููุณุชุฏุนู `retrieve` ูุน ุญุฒูุฉ ุงุณุชุนูุงู
- ูุฌูุจ ุงููุงุฆู (ูุณุชูุฑุฌุนุ ูุญุฑู ุงุณุชุนูุงูุ ุฃู ุนูุฏุฉ) ููุนุฑู ุงูุญุงูู
- ูู ุนูุฏุฉุ ูุถูููุง ููุงุฆูุฉ ุงูุนูุฏ ููุฅุฑุฌุงุน
- ูู ูุณุชูุฑุฌุนุ ูุณุชุฑุฌุน ุงูุนูุฏ ููุณุชุนูููุง ุจุดูู ุชูุฑุงุฑู
- ูู ูุญุฑู ุงุณุชุนูุงูุ ูุณุชุนููู ููุถูู ุงูุงุณุชุฌุงุจุฉ ูุนูุฏุฉ ูุต

##### ๐ ุงุณุชุนูุงู ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ

- ููู IndexNode ูุณุชูุฑุฌุนุ ูุณุชุฑุฌุน ุจุดูู ุชูุฑุงุฑู ูู ุงููุนุฑู ุงููุฑุฌุนู
- ููู TextNodeุ ูุถูููุง ุจุณ ููุงุฆูุฉ ุงูุนูุฏ ููุฅุฑุฌุงุน
- ูุชุฌูุจ ุงุณุชุนูุงู ููุณ ุงููุนุฑู ุนุฏุฉ ูุฑุงุช

##### ๐งน ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ

- ูุฒูู ุชูุฑุงุฑ ุงูุนูุฏ ุจูุงุกู ุนูู ูุนุฑู ุงูุนูุฏุฉ
- ูุญุชูุธ ุจุงูุนูุฏุฉ ุจุฃุนูู ูุชูุฌุฉ ุฃู ุฃูู ูุงุญุฏุฉ ูุฑุฌูุนุฉ

##### ๐ ุงุณุชุฑุฌุงุน ุฌููุน ุงูุนูุฏ

- ุทุฑููุฉ `retrieve_all` ุจุชุณุชุฑุฌุน ูู ุงูุนูุฏุ ุจูุง ูููุง ุนูุฏ ุงููุตุฏุฑ ุงูุฅุถุงููุฉ
- ุจุชุณุชุฏุนู ุนูููุฉ ุงูุงุณุชุฑุฌุงุน ุงูุชูุฑุงุฑูุฉ ูุจุชุฑุฌุน ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ ูุงูุฅุถุงููุฉ

#### [`RetrieverQueryEngine`](https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/query_engine/retriever_query_engine.py)

ููุท `index.as_retriever()` ุจููุดุฆ ูุณุชูุฑุฌุน ูู ููุฑุณ. ููุน ุงููุณุชูุฑุฌุน ุงููู ุจููุดุฆู ุจูุนุชูุฏ ุนูู ูุนุงูู `retriever_mode` ุงููู ุจุชูุฑุฑู ููู.

ูุจุงูุชุงููุ ูู ุญูู ุฅู `index.as_retriever()` ุจููุณุชุฎุฏู ูุฅูุดุงุก ูุณุชูุฑุฌุน ูู ููุฑุณุ `RetrieverQueryEngine` ุจูุณุชุฎุฏู ูุณุชูุฑุฌุน ูุฌูุจ ุงูุนูุฏ ุฐุงุช ุงูุตูุฉ ู `ResponseSynthesizer` ูุชุฑููุจ ุงุณุชุฌุงุจุฉ.

##### ๐ฟ ุงูุชููุฆุฉ

- ุจูุงุฎุฏ ูุณุชูุฑุฌุนุ ููุฑูุจ ุงุณุชุฌุงุจุฉ ุงุฎุชูุงุฑูุ ููุนุงูุฌุงุช ุนูุฏ ูุงุญูุฉ
- ุจููุดุฆ ููุฑูุจ ุงุณุชุฌุงุจุฉ ุงูุชุฑุงุถู ูู ูุด ูุชููุฑ
- ุจูุฌูุฒ ูุฏูุฑ ุงูุงุณุชุฏุนุงุกุงุช ููุญุฑู ุงูุงุณุชุนูุงู ููุนุงูุฌุงุช ุงูุนูุฏ ุงููุงุญูุฉ

##### ๐ง ุงูุชุฎุตูุต

- ูููู ูุชููุฃ ุจูุนุงููุงุช ูุฎุชููุฉ ุจุงุณุชุฎุฏุงู ุทุฑููุฉ `from_args`
- ุจูุณูุญ ุจุชุฎุตูุต ูุถุน ุงูุงุณุชุฌุงุจุฉุ ููุงูุจ ุงูู promptุ ุงูุงุณุชุฎุฏุงู ุบูุฑ ุงููุชุฒุงููุ ุฅูุฎ.

##### ๐ ุงูุงุณุชุฑุฌุงุน

- ุจูุณุชุฑุฌุน ุงูุนูุฏ ุจุงุณุชุฎุฏุงู ุงููุณุชูุฑุฌุน ุงูููุฏู ููุง ููุณุชุฏุนู `retrieve` ุฃู `aretrieve`
- ุจูุทุจู ูุนุงูุฌุงุช ุงูุนูุฏ ุงููุงุญูุฉ ุนูู ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ
- ุจูุฑุฌุน ุงูุนูุฏ ุงููุนุงููุฌุฉ

##### ๐ ุชุจุฏูู ุงููุณุชูุฑุฌุน

- ุจูุณูุญ ุจุชุจุฏูู ุงููุณุชูุฑุฌุน ุจุงุณุชุฎุฏุงู ุทุฑููุฉ `with_retriever`
- ุจููุดุฆ ูููุฐุฌ RetrieverQueryEngine ุฌุฏูุฏ ุจุงููุณุชูุฑุฌุน ุงูุฌุฏูุฏ

##### ๐งฉ ูุนุงูุฌุฉ ุงูุนูุฏ ุงููุงุญูุฉ

- ุจูุทุจู ูุงุฆูุฉ ูู ูุนุงูุฌุงุช ุงูุนูุฏ ุงููุงุญูุฉ ุนูู ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉ
- ุงููุนุงูุฌุงุช ูููู ุชุนุฏู ุฃู ุชุตูู ุงูุนูุฏ ุจูุงุกู ุนูู ุญุฒูุฉ ุงูุงุณุชุนูุงู

##### ๐จ ุชุฑููุจ ุงูุงุณุชุฌุงุจุฉ

- ุจููุฑูุจ ุงุณุชุฌุงุจุฉ ุจุงุณุชุฎุฏุงู ููุฑูุจ ุงูุงุณุชุฌุงุจุฉ
- ุจูุงุฎุฏ ุญุฒูุฉ ุงูุงุณุชุนูุงูุ ุงูุนูุฏ ุงููุณุชูุฑุฌุนุฉุ ูุนูุฏ ุงููุตุฏุฑ ุงูุฅุถุงููุฉ ููุฏุฎูุงุช
- ุจูููุฏ ุงุณุชุฌุงุจุฉ ุจูุงุกู ุนูู ูุถุน ุงูุงุณุชุฌุงุจุฉ ูุงูููุงูุจ ุงูููููุฃุฉ

##### โ ุงูุงุณุชุนูุงู

- ุจูุชุนุงูู ูุน ุงุณุชุนูุงู ุจุงุณุชุฎุฏุงู ุทุฑููุฉ `_query` ุฃู `_aquery`
- ุจูุณุชุฑุฌุน ุงูุนูุฏุ ุจููุฑูุจ ุงุณุชุฌุงุจุฉุ ูุจูุฑุฌุน ุงูุงุณุชุฌุงุจุฉ
- ุจูุดุบู ุฃุญุฏุงุซ ุงูุงุณุชุฏุนุงุก ูุจุฏุงูุฉ ูููุงูุฉ ุงูุงุณุชุนูุงู

##### ๐ ุฏุนู ุบูุฑ ูุชุฒุงูู

- ุจูููุฑ ูุณุฎ ุบูุฑ ูุชุฒุงููุฉ ูู ุทุฑู ุงูุงุณุชุฑุฌุงุนุ ุงูุชุฑููุจุ ูุงูุงุณุชุนูุงู
- ุจูุณูุญ ุจูุนุงูุฌุฉ ุบูุฑ ูุชุฒุงููุฉ ููุงุณุชุนูุงูุงุช

```python
from llama_index.core.query_engine import RetrieverQueryEngine
from llama_index.core.retrievers import RecursiveRetriever

parent_child_retriever = parent_child_index.as_retriever(
    response_mode="compact",
    similiarty_top_k=5,
    vector_store_query_mode="mmr", 
    vector_store_kwargs={"mmr_threshold": 0.42},
)

retriever_chunk = RecursiveRetriever(
    "vector",
    retriever_dict={"vector": parent_child_retriever},
    node_dict=all_nodes_dict,
    verbose=True,
)

parent_child_query_engine = RetrieverQueryEngine.from_args(retriever_chunk, llm=Settings.llm)

parent_child_query_engine.update_prompts({'response_synthesizer:text_qa_template': HYPE_ANSWER_GEN_PROMPT_TEMPLATE})
```

### ๐ง ุฅุนุฏุงุฏ ุฎุท ุฃูุงุจูุจ ุงูุงุณุชุนูุงู ููุทุน ุงูุฃุจ ูุงูุทูู

```python
from utils import create_query_pipeline
from llama_index.core.query_pipeline import InputComponent

input_component = InputComponent()

parent_child_chain = [input_component, parent_child_query_engine]

parent_child_query_pipeline = create_query_pipeline(parent_child_chain)
```

```python
parent_child_query_pipeline.run(input="ุฅุฒุงู ุฃูุฏุฑ ุฃุจูู ููุฉ ุจุดูู ูุนุงู ูู ุฌูุงูุจ ูุชุนุฏุฏุฉ ูู ุงูุญูุงุฉ ุงูุญููููุฉ ูู ุบูุฑ ูุง ุฃุนุชูุฏ ุนูู ุขูุงุช ูุนูุฏุฉุ")
```

```python
parent_child_query_pipeline.run(input="ุฅุฒุงู ุฃูุฏุฑ ุฃุญุท ููุงุนุฏ ูุฃุชููู ุจุตุฑุงุญุฉ ูู ุบูุฑ ูุง ุฃููู ุนูู ุฌุฑุญ ูุดุงุนุฑ ุญุฏุ")
```

</div>
