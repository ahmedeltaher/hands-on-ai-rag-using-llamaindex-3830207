# ๐ง ุงูุชูุทูุน ุงูุฏูุงูู (Semantic Chunking)

<div dir="rtl">

ุฏู ุทุฑููุฉ ุญุฏูุซุฉ ุงุชุดูุฑุช ุจููุง Greg Kamradt. ุงุชููู ุนููุง ุจุงูุชูุตูู ูู [ููุฏูู ููุชููุจ ูููุฏ](https://youtu.be/8OJC21T2SL4)ุ ูุงููู ููุงู ูุตุฏุฑ ุฑุงุฆุน ููุนูููุงุช ุฃูุชุฑ ุนู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชูุทูุน ุงููุฎุชููุฉ.

ุฎูุงุตุฉ ุงูุชูุทูุน ุงูุฏูุงูู ุจูุนูู ุฅูู:

- ุจูุณุชุฎุฏู ุชุถูููุงุช ุงูุฌูู ูุฅูุฌุงุฏ ููุงุท ุงููุตู ุจูุงุกู ุนูู ุงูุชุดุงุจู ุงูุฏูุงูู
- ุจูุฎูู ุงูุฌูู ุงููุฑุชุจุทุฉ ูุน ุจุนุถ ูู ููุณ ุงููุทุนุฉ
- ุจูุญุฏุฏ ุญุฌู ุงููุทุนุฉ ุฏููุงููููุงูุ ูุด ูุญุชุงุฌ ุทูู ุซุงุจุช

## ุฅุฒุงู ุงูุชูุทูุน ุงูุฏูุงูู ุจูุดุชุบู

1. โ๏ธ ูุณู ุงููุณุชูุฏ ูุฌูู

2. ๐ข ููุฑุณ ุงูุฌูู ุญุณุจ ุงูููุถุน

3. ๐๏ธ ุงุฎุชุฑ ุญุฌู ุงูุญุงุฌุฒ (ุงูุฌูู ุนูู ูู ุฌุงูุจ ููุญูุงุธ ุนูููุง)

4. ๐ ููุณ ุงูุชุดุงุจู ูู ูุถุงุก ุงูุชุถููู
   - ุฎูู ุงูุฌูู ุงููุชุดุงุจูุฉ ูุน ุจุนุถ
   - ุงูุตู ุงูุฌูู ุงููุฎุชููุฉ

5. ๐งฉ ุงุฏูุฌ ุงููุฌููุนุงุช ุจูุงุกู ุนูู ุนุชุจุฉ ุงูุชุดุงุจู

## [`SemanticSplitterNodeParser`](https://github.com/run-llama/llama_index/blob/main/llama-index-core/llama_index/core/node_parser/text/semantic_splitter.py)

ุงูู SemanticSplitterNodeParser ุจููุณู ูุณุชูุฏ ููุทุน ูุฑุชุจุทุฉ ุฏูุงููุงู ุงุณููุง ุนูุฏ. ุจูุณุชุฎุฏู ุงูุชุดุงุจู ุงูุฏูุงูู ูุชุญุฏูุฏ ููุงุท ุงููุตู ุงูุชููููุฉุ ูุฅูุดุงุก ุนูุฏ ูุนูุงูุง ูุงุถุญ ููุชูุงุณูุฉ ูู ูุณุชูุฏ.

### ุฅุฒุงู ุจูุดุชุบู

#### 1. ๐งฉ ุชูุณูู ุงููุณุชูุฏ

   - ุงููุญูู ุจูุงุฎุฏ ูุณุชูุฏ ููุฏุฎู.
   
   - ุจููุณู ุงููุณุชูุฏ ูุฌูู ูุฑุฏูุฉ ุจุงุณุชุฎุฏุงู ููุณู ุฌูู (ูุซูุงูุ split_by_sentence_tokenizer).

#### 2. ๐๏ธ ุชุฌููุน ุงูุฌูู

   - ุงููุญูู ุจูุฌูุน ุงูุฌูู ุงููุชุฌุงูุฑุฉ ูุน ุจุนุถ ุจูุงุกู ุนูู ุญุฌู ุญุงุฌุฒ ูุงุจู ููุชููุฆุฉ.
   
   - ุญุฌู ุงูุญุงุฌุฒ ุจูุญุฏุฏ ูุงู ุฌููุฉ ุจุชุชุงุฎุฏ ูู ุงูุงุนุชุจุงุฑ ูุน ุจุนุถ ุนูุฏ ุชูููู ุงูุชุดุงุจู ุงูุฏูุงูู.
   
   - ูุซูุงูุ ูู ุญุฌู ุงูุญุงุฌุฒ 1ุ ูู ุฌููุฉ ุจุชุชุนุงูู ุจุดูู ูุฑุฏู. ูู ุฃูุจุฑ ูู 1ุ ุงูุฌูู ุจุชุชุฌูุน ูุน ุจุนุถ.

#### 3. ๐ ุญุณุงุจ ุงูุชุถููู

   - ุงููุญูู ุจูุญุณุจ ุงูุชุถูููุงุช ููู ูุฌููุนุฉ ุฌูู ุจุงุณุชุฎุฏุงู ูููุฐุฌ ุชุถููู.
   
   - ุงูุชุถูููุงุช ุจุชูุซู ุงููุนูู ุงูุฏูุงูู ููุฌููุนุงุช ุงูุฌูู ูู ุตูุบุฉ ูุชุฌูุฉ ูุซููุฉ.

#### 4. ๐ ุญุณุงุจ ุงููุณุงูุฉ

   - ุงููุญูู ุจูุญุณุจ ุชุดุงุจู ุฌูุจ ุงูุชูุงู ุจูู ุชุถูููุงุช ูุฌููุนุงุช ุงูุฌูู ุงููุชุฌุงูุฑุฉ.
   
   - ุจุนุฏูู ุจูุญุณุจ ุงููุณุงูุฉ ุจุทุฑุญ ุงูุชุดุงุจู ูู 1.
   
   - ุงููุณุงูุงุช ุฏู ุจุชูุซู ุนุฏู ุงูุชุดุงุจู ุงูุฏูุงูู ุจูู ูุฌููุนุงุช ุงูุฌูู.

#### 5. ๐ฏ ุชุญุฏูุฏ ููุงุท ุงููุตู

   - ุงููุญูู ุจูุญุฏุฏ ููุงุท ุงููุตู ุจูุงุกู ุนูู ุนุชุจุฉ ูุฆููุฉ ูุงุจูุฉ ููุชููุฆุฉ (ูุซูุงูุ ุงููุฆูู ุงูู95).
   
   - ูู ุงููุณุงูุฉ ุจูู ูุฌููุนุชู ุฌูู ูุชุฌุงูุฑุชูู ุชุชุฌุงูุฒ ุนุชุจุฉ ููุทุฉ ุงููุตูุ ุฏู ุจูุดูุฑ ูุชุญูู ุฏูุงูู ูุจูุญุฏุฏ ุจุฏุงูุฉ ุนูุฏุฉ ุฌุฏูุฏุฉ.

#### 6. ๐งฉ ุฅูุดุงุก ุงูุนูุฏุฉ

   - ุงููุญูู ุจููุณู ุงููุณุชูุฏ ูุนูุฏ ุจูุงุกู ุนูู ููุงุท ุงููุตู ุงููุญุฏุฏุฉ.
   
   - ูู ุนูุฏุฉ ุจุชูุซู ูุทุนุฉ ูุต ูุฑุชุจุทุฉ ุฏูุงููุงู.
   
   - ุงูุฌูู ุฏุงุฎู ุงูุนูุฏุฉ ุจุชุชุฌูุน ูุชูููู ูุญุฏุฉ ูุนูููุงุช ูุชูุงุณูุฉ.

#### 7. ๐ ุงูุจูุงูุงุช ุงููุตููุฉ ููุนูุฏุฉ

   - ุงููุญูู ูููู ูุถูู ุจูุงูุงุช ูุตููุฉ ุฅุถุงููุฉ ูู ุงูุนูุฏุ ุฒู ุงููุต ุงูุฃุตูู ุฃู ูุนูููุงุช ุฐุงุช ุตูุฉ ุชุงููุฉ.
   
   - ููุงู ูููู ููุดุฆ ุนูุงูุงุช ุจูู ุงูุนูุฏุ ุฒู ุนูุงูุงุช ุงูุณุงุจู ูุงูุชุงููุ ููุญูุงุธ ุนูู ุงูุชุฑุชูุจ ุงูุชุณูุณูู ูููุทุน.

### ูุนุงููุงุช ูุงุฒู ุชุนุฑููุง

- `embed_model`: ูููุฐุฌ ุงูุชุถููู ุงููุณุชุฎุฏู ููููุงุฑูุฉ ุงูุฏูุงููุฉ. ูู ูุด ูุชููุฑุ ุงููุญูู ููุญุงูู ูุณุชุฎุฏู ูููุฐุฌ OpenAIEmbedding. ูู ุญุฒูุฉ `llama-index-embeddings-openai` ูุด ููุตุจุฉุ ููุธูุฑ ImportError.

- `buffer_size`: ุนุฏุฏ ุงูุฌูู ุงููุฑุงุฏ ุชุฌููุนูุง ูุน ุจุนุถ ุนูุฏ ุชูููู ุงูุชุดุงุจู ุงูุฏูุงูู.

  - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ 1 (ูู ุฌููุฉ ุจุชุชุงุฎุฏ ูู ุงูุงุนุชุจุงุฑ ุจุดูู ูุฑุฏู).
  
  - ุฒูุงุฏุฉ ุญุฌู ุงูุญุงุฌุฒ ุจุชุณูุญ ูููุญูู ูุงุฎุฏ ูู ุงูุงุนุชุจุงุฑ ุณูุงู ุงูุฌูู ุงููุฌุงูุฑุฉ ููุง ูุญุฏุฏ ุงูุชุดุงุจู ุงูุฏูุงูู. ุฏู ูููู ูุณุงุนุฏ ูู ุงูุชูุงุท ุนูุงูุงุช ุฃูุซุฑ ูุนูู ุจูู ุงูุฌูู.

- `breakpoint_percentile_threshold`: ุงููุฆูู ูุนุฏู ุงูุชุดุงุจู ูู ุฌูุจ ุงูุชูุงู ุงููู ูุงุฒู ูุชุฌุงูุฒ ุจูู ูุฌููุนุฉ ุฌูู ูุงููุฌููุนุฉ ุงููู ุจุนุฏูุง ูุชูููู ุนูุฏุฉ.

  - ูููุฉ ุฃุตุบุฑ ุจุชูุชุฌ ุนูุฏ ุฃูุชุฑ. ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ 95 (ุงููุฆูู ุงูู95).
  
  - ุชุนุฏูู ุงูุนุชุจุฉ ุฏู ุจูุณูุญ ูู ุชุชุญูู ูู ุฏูุฉ ุชูุณููุงุช ุงูุนูุฏ. ูููุฉ ุฃูู ูุชูุดุฆ ุนูุฏ ุฃูุชุฑุ ุจูููุง ูููุฉ ุฃุนูู ูุชูุดุฆ ุนูุฏ ุฃูู.

- `sentence_splitter`: ุงูุฏุงูุฉ ุฃู ุงููุงุฆู ุงููุงุจู ููุงุณุชุฏุนุงุก ุงููุณุชุฎุฏู ูุชูุณูู ุงููุต ูุฌูู. ุงูุงูุชุฑุงุถู ูู `split_by_sentence_tokenizer` (ูุฑุฉ ุชุงููุฉุ ุจุงุณุชุฎุฏุงู `PunktSentenceTokenizer` ูู ููุชุจุฉ `nltk`). ุงุฎุชูุงุฑ ููุณู ุงูุฌูู ูููู ูุฃุซุฑ ุนูู ููููุฉ ุชูุณูู ุงููุต ูุฌูู ูุฑุฏูุฉุ ูุงููู ุจุฏูุฑู ุจูุฃุซุฑ ุนูู ุนูููุฉ ุชูุณูู ุงูุนูุฏ.

  - ุจูููุง ุจูุชู ุงุณุชุฎุฏุงู `sentence_splitter` ูุชูุณูู ุงููุณุชูุฏ ูู ุงูุจุฏุงูุฉ ูุฌูู ูุฑุฏูุฉุ ุงูุชุญุฏูุฏ ุงููุนูู ูุญุฏูุฏ ุงูุนูุฏุฉ ุจูุนุชูุฏ ุนูู ุงูุชุดุงุจู ุงูุฏูุงูู ุจุฏูุงู ูู ููุฌ ุชูุณูู ุซุงุจุช.
  
  - `sentence_splitter` ุฃูุชุฑ ุฒู ุฎุทูุฉ ูุนุงูุฌุฉ ุฃูููุฉ ูุชุฌููุฒ ุงููุณุชูุฏ ููุชุญููู ุงูุฏูุงูู. ุจูุถูู ุฅู ุงููุญูู ุนูุฏู ุตูุบุฉ ูุฏุฎู ูุชุณูุฉ ููุนูู ุจููุง (ูุนููุ ูุงุฆูุฉ ูู ุงูุฌูู).

### ููุฏ ุงูุชุทุจูู

```python
from llama_index.core.node_parser import SentenceSplitter, SemanticSplitterNodeParser

def semantic_splitter(
    embed_model,
    buffer_size, 
    breakpoint_percentile_threshold, 
    documents,
    **kwargs):
    splitter = SemanticSplitterNodeParser(
        embed_model=embed_model,
        buffer_size=buffer_size,
        breakpoint_percentile_threshold=breakpoint_percentile_threshold,
    )
    nodes = splitter.get_nodes_from_documents(documents)
    return nodes
```

## ุนูุฏู ุฎูุงุฑุงุช ุชุตููู ูุชูุฑ ูุงุฒู ุชุงุฎุฏูุง ููุง

ุฏู ูููุง ููุงุท ุชุฌุฑูุจ ููู. ุงูุนุจ ูุนุงููุ ุงุนูู ุชูููู ุถุฏ ุงูููุงููุณ ุงููููุฉ ูููุ ุงุฎุชุจุฑ ุงููุชุงุฆุฌุ ููุงูู ุงููู ูุดุชุบู ุฃุญุณู.

- ุฅูู ูููุฐุฌ ุงูุชุถููู ุงููู ุนุงูุฒ ุชุณุชุฎุฏููุ

- ุฅูู ุงูุฃุจุนุงุฏ ุงููู ุนุงูุฒ ุชุณุชุฎุฏููุง ููููุฐุฌ ุงูุชุถูููุ

- ุฅูู ุญุฌู ุงูุญุงุฌุฒ ุงููู ุนุงูุฒ ุชุณุชุฎุฏููุ

- ูุฅูู ุฑุฃูู ูู ุนุชุจุฉ ููุทุฉ ุงููุตูุ

- ุฅูู ููุณู ุงูุฌูู ุงููู ุนุงูุฒ ุชุณุชุฎุฏููุ

ูุณุชุฎุฏู ุจุนุถ ุงูุฅุนุฏุงุฏุงุช ุงูุชุนุณููุฉ ูุฃุบุฑุงุถ ุชูุถูุญูุฉ.

```python
semantic_nodes = semantic_splitter(
    embed_model = Settings.embed_model,
    buffer_size = 3, 
    breakpoint_percentile_threshold = 0.55, 
    documents = senpai_documents
)
```

```python
len(semantic_nodes)
```

```python
semantic_nodes[101].__dict__
```

```python
print(semantic_nodes[100].get_content(metadata_mode="all"))
```

## ๐ท๐ฝโโ๏ธ ๐๏ธ ุจูุงุก ุงูููุฑุณ ูุงูุฅุฏุฎุงู ูู Qdrant

ููุญูุธุฉ: ุฏู ููุงู ููุงุฎุฏ ููุช ุทููู (ุญูุงูู 30 ุฏูููุฉ)

```python
from llama_index.core import StorageContext
from llama_index.core.settings import Settings

from utils import create_index, create_query_engine, ingest, setup_vector_store

COLLECTION_NAME = "words-of-the-senpai-semantic-nodes"

semantic_nodes_vector_store = setup_vector_store(":memory:", QDRANT_API_KEY, COLLECTION_NAME)
```

```python
transforms = [Settings.embed_model]

semantic_nodes = ingest(
    documents=semantic_nodes,
    transformations=transforms,
    vector_store=semantic_nodes_vector_store
)

semantic_nodes_index = create_index(
    from_where="vector_store", 
    embed_model=Settings.embed_model,
    vector_store=semantic_nodes_vector_store
)
```

### ๐๏ธ ุฅุนุฏุงุฏ ูุญุฑู ุงูุงุณุชุนูุงู

```python
from llama_index.core import PromptTemplate
from llama_index.core.postprocessor import MetadataReplacementPostProcessor

from utils import create_query_engine
from prompts import HYPE_ANSWER_GEN_PROMPT

HYPE_ANSWER_GEN_PROMPT_TEMPLATE = PromptTemplate(HYPE_ANSWER_GEN_PROMPT)

semantic_nodes_query_engine = create_query_engine(
    index=semantic_nodes_index, 
    mode="query",
    response_mode="compact",
    similiarty_top_k=5,
    vector_store_query_mode="mmr", 
    vector_store_kwargs={"mmr_threshold": 0.42},
    text_qa_template=HYPE_ANSWER_GEN_PROMPT_TEMPLATE
)
```

### ๐ง ุฅุนุฏุงุฏ ุฎุท ุฃูุงุจูุจ ุงูุงุณุชุนูุงู

```python
from utils import create_query_pipeline
from llama_index.core.query_pipeline import InputComponent

input_component = InputComponent()

semantic_nodes_chain = [input_component, semantic_nodes_query_engine]

semantic_nodes_query_pipeline = create_query_pipeline(semantic_nodes_chain)
```

```python
semantic_nodes_query_pipeline.run(input="ุฅุฒุงู ุฃูุฏุฑ ุฃุชููู ูู ูุชุงูุฉ ุงูุณูู ูุฃูุง ุจุงุจูู ุดุฑูุฉุ")
```

</div>
