# ุชุญูููุงุช ุงูุงุณุชุนูุงู (Query Transformation)

<div dir="rtl">

ููุง ุจูุชุนุงูู ูุน ุงุณุชุนูุงูุงุช ุงููุณุชุฎุฏู ูู ูุธุงู RAGุ ููููุ ุฃู ุฃู ุฎุท ุฃูุงุจูุจ ุชุงููุ ูู ุทุฑู ูุฎุชููุฉ ูุชุญููู ูุชุญููู ุงูุงุณุชุนูุงูุงุช ูุจู ุชูููุฐูุง.

ุทุฑููุฉ ูุงุญุฏุฉ ูู ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุงุณุชุนูุงู. ุฏู ุจุชุชุถูู ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุงุณุชุนูุงู ุงูุฃุตูู ุจุทุฑู ูุชุนุฏุฏุฉ ูุงููู ุจุนุฏูู ุจุชุชุจุนุช ููุงุณุชุฑุฌุงุน ูุงูุชูููุฏ.

LlamaIndex ุจูููุฐ ุชุญูููุงุช ุงุณุชุนูุงู ูุฎุชููุฉุ [ุงุทูุน ุนูู ุงูููุฏ ุงููุตุฏุฑู ููุชูุงุตูู](https://github.com/run-llama/llama_index/blob/f116d75557d6867ed2cc61811a1c2f0b0c4d4ddb/llama-index-legacy/llama_index/legacy/indices/query/query_transform/base.py).

## ุฅุนุฏุงุฏ ูุฎุฒู ุงููุชุฌูุงุช Qdrant

```python
from llama_index.core import StorageContext
from llama_index.core.settings import Settings

from llama_index.core.node_parser import SentenceSplitter
from utils import create_index, create_query_engine, ingest, setup_vector_store

COLLECTION_NAME = "query-transforms"

vector_store = setup_vector_store(QDRANT_URL, QDRANT_API_KEY, COLLECTION_NAME)

sentence_splitter = SentenceSplitter(chunk_size=256, chunk_overlap=16)

nodes = ingest(
    documents=senpai_documents,
    transformations=[sentence_splitter, Settings.embed_model],
    vector_store=vector_store
)

index = create_index(
    from_where="vector_store",
    vector_store=vector_store,
    embed_model=Settings.embed_model,
)
```

## ุชูููุฏ ุงุณุชุนูุงูุงุช ุจุฏููุฉ

```python
from llama_index.core import PromptTemplate

QUERY_GEN_PROMPT = """ุงููุณุชุฎุฏููู ูุด ุฏุงููุงู ุงูุฃุญุณู ูู ุงูุชุนุจูุฑ ุนู ุงููู ุจูุฏูุฑูุง ุนููู. ูููุชู ุฅูู ุชููู 
ุฌููุฑ ุงุณุชุนูุงู ุงููุณุชุฎุฏู ูุชููุฏ {num_queries} ุงุณุชุนูุงูุงุช ุจุฏููุฉ ูุชูุณูุน ุงุณุชุนูุงู ุงููุณุชุฎุฏู ุนุดุงู ูููู ุฃููู. ุจุงูุทุฑููุฉ ุฏู ุงููุณุชุฎุฏู 
ููุณุชูุจู ุฃูุชุฑ ุงููุนูููุงุช ุฐุงุช ุงูุตูุฉ.

ุฃูุซูุฉ ูุญุฏุฏุฉ ุจุซูุงุซ ุนูุงูุงุช ุงูุชุจุงุณ (```) ุชุญุช

````
ุงุณุชุนูุงู ุงููุณุชุฎุฏู: ุฅุฒุงู ุฃูุฏุฑ ุฃูุงูู ุงูุฅูุฌุงุจู ูู ุงูููุงูู ุงููู ุจุชุจุงู ุณูุจูุฉุ

ุงูุงุณุชุนูุงูุงุช ุงูุจุฏููุฉ:

1. ุฅุฒุงู ุฃูุฏุฑ ุฃุฒุฑุน ุงูุชูุงุคู ูุงูุชูููุฑ ุงูุฅูุฌุงุจู ูู ุญูุงุชู ุงูููููุฉุ
2. ูู ูููู ุฃูุงูู ูุนูู ููุฏู ูู ุงูุฃููุงุช ุงูุตุนุจุฉ ุฃู ุงูุตุนุจุฉุ
3. ุฅูู ุจุนุถ ุงูุงุณุชุฑุงุชูุฌูุงุช ุงููุนุงูุฉ ูุฅุนุงุฏุฉ ุตูุงุบุฉ ุงูุฃููุงุฑ ุงูุณูุจูุฉ ูุฅูุฌุงุจูุฉุ
````

````
ุงุณุชุนูุงู ุงููุณุชุฎุฏู: ุฅุฒุงู ุฃุชุนุงูู ูุน ุงูููุณุงุชุ ุงููุดูุ ุงูุชุฃุฎูุฑุ ุงููุฒููุฉุ ุฃู ููุงุฑุซ ุชุงููุฉุ

ุงูุงุณุชุนูุงูุงุช ุงูุจุฏููุฉ:

1. ุฅุฒุงู ุฃูุฏุฑ ุฃุจูู ุงููุฑููุฉ ูุฃุชุนูู ุฃุชุนุงูู ูุน ุงูุดุฏุงุฆุฏ ุจูุนุงููุฉุ
2. ุฅูู ุจุนุถ ุงููุตุงูุญ ุงูุนูููุฉ ููุชุบูุจ ุนูู ุงูุชุญุฏูุงุช ูุงูุนูุจุงุช ุงููู ุจูุงุฌููุงุ
3. ุฅุฒุงู ุฃูุฏุฑ ุฃุทูุฑ ุนูููุฉ ุงูููู ูุฃุดูู ุงูููุณุงุช ููุฑุต ููุชุนููุ
4. ุฅูู ุงูุทุฑู ุงูุตุญูุฉ ููุนุงูุฌุฉ ูุงูุชุนูู ูู ุงููุดู ูุงูุฃุฎุทุงุกุ
````

````
ุงุณุชุนูุงู ุงููุณุชุฎุฏู: ุฅุฒุงู ุฃูุฏุฑ ุฃุชุบูุจ ุนูู ุงููุฒููุฉ ูุงููุนุงูุงุฉ ุจุชุบููุฑ ุนูููุชูุ

ุงูุงุณุชุนูุงูุงุช ุงูุจุฏููุฉ:

1. ุฅูู ููุฉ ุงูุชูููุฑ ุงูุฅูุฌุงุจู ูุงูุชุฃููุฏุงุชุ ูุฅุฒุงู ูููู ุชููุฏููุ
2. ูู ููุงุฑุณุงุช ุงูููุธุฉ ูุงูุชุฃูู ูููู ุชุญุณู ุตุญุชู ุงูููุณูุฉ ููุธุฑุชูุ
3. ุฅุฒุงู ุฃูุฏุฑ ุฃุทูุฑ ุงูุฑุฃูุฉ ุงูุฐุงุชูุฉ ูุงููุจููุ ุฎุตูุตุงู ุฎูุงู ุงูุฃููุงุช ุงูุตุนุจุฉุ
```

ููุฏ {num_queries} ุงุณุชุนูุงูุงุช ุจุฏููุฉุ ูุงุญุฏ ุนูู ูู ุณุทุฑุ ูุงุณุชุนูุงู ุงููุณุชุฎุฏู ุงูุชุงูู:\n
--------------------
ุงุณุชุนูุงู ุงููุณุชุฎุฏู: {query}\n
--------------------

ุงูุงุณุชุนูุงูุงุช ุงูุจุฏููุฉ:\n
"""

QUERY_GEN_PROMPT_TEMPLATE = PromptTemplate(QUERY_GEN_PROMPT)
```

```python
QUERY_STRING = "ุฅุฒุงู ุฃูุฏุฑ ุฃุฎูู ุงูุญุธ ุจุชุงุนู ุจููุณูุ"

def generate_queries(query=QUERY_STRING, llm=Settings.llm, num_queries=4):
    response = llm.predict(
        QUERY_GEN_PROMPT_TEMPLATE, 
        num_queries=num_queries, 
        query=query
    )
    queries = response.split("\n")
    queries_str = "\n".join(queries)
    print(f"ุงูุงุณุชุนูุงูุงุช ุงููููุฏุฉ:\n{queries_str}")
    return queries

generate_queries()
```

## `SubQuestionQueryEngine`

ุงูู `SubQuestionQueryEngine` ุจูุดุชุบู ุนู ุทุฑูู ุชูุณูู ุงุณุชุนูุงู ูุนูุฏ ูุฃุณุฆูุฉ ูุฑุนูุฉ ุฃุจุณุท (ูู ูุงุญุฏ ูููู ูุณุชูุฏู ูุตุฏุฑ ุจูุงูุงุช ูุญุฏุฏ).

### ุฅุฒุงู ุจูุดุชุบู:

- ุงูู `SubQuestionQueryEngine` ุจูุณุชูุจู ุงุณุชุนูุงู ูุนูุฏ.

- ุจุนุฏูู ุจูุญูู ุงูุงุณุชุนูุงู ุฏู ูุนุฏุฉ ุฃุณุฆูุฉ ูุฑุนูุฉ. ูู ุณุคุงู ูุฑุนู ูุตูู ูุงุณุชุฎุฑุงุฌ ูุนูููุงุช ูุญุฏุฏุฉ ูู ูุตุฏุฑ ุจูุงูุงุช ูุนูู.

- ุงููุญุฑู ุจุนุฏูู ุจูุจุนุช ุงูุฃุณุฆูุฉ ุงููุฑุนูุฉ ุฏู ููุตุงุฏุฑ ุงูุจูุงูุงุช ุงููุนููุฉ ูุจูุฌูุน ุงูุงุณุชุฌุงุจุงุช.

- ุฃุฎูุฑุงูุ ุจูุฑูุจ ูู ุงูุงุณุชุฌุงุจุงุช ุงููุณูุทุฉ ูุชูููู ุฅุฌุงุจุฉ ููุงุฆูุฉ ุดุงููุฉ ููุงุณุชุนูุงู ุงูุฃุตูู ุงููุนูุฏ.

ุงูุนูููุฉ ุฏู ุจุชุฎูู `SubQuestionQueryEngine` ูููุฏ ุจุดูู ุฎุงุต ููุชุนุงูู ูุน ุงุณุชุนูุงูุงุช ุงูููุงุฑูุฉ/ุงูุชุจุงูู ุนุจุฑ ุงููุณุชูุฏุงุชุ ูููุงู ุงูุงุณุชุนูุงูุงุช ุงููุชุนููุฉ ุจูุณุชูุฏ ูุญุฏุฏ. ููุงู ููุงุณุจ ููุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ ุงููุณุชูุฏุงุช ููููู ูููุฐ ุฃู ุนุฏุฏ ูู ุงูุงุณุชุนูุงูุงุช ุงููุฑุนูุฉ ุถุฏ ุฃู ูุฌููุนุฉ ูุฑุนูุฉ ูู ุฃุฏูุงุช ูุญุฑู ุงูุงุณุชุนูุงู ูุจู ุชุฑููุจ ุงูุฅุฌุงุจุฉ ุงูููุงุฆูุฉ.

```python
from llama_index.core.tools import QueryEngineTool, ToolMetadata
from llama_index.core.query_engine import SubQuestionQueryEngine

from prompts import HYPE_ANSWER_GEN_PROMPT

HYPE_ANSWER_GEN_PROMPT_TEMPLATE = PromptTemplate(HYPE_ANSWER_GEN_PROMPT)

query_engine_tools = [
    QueryEngineTool(
        query_engine=index.as_query_engine(),
        metadata=ToolMetadata(
            name="ุงูุณููุจุงู",
            description="ุงูุฃููุงุฑ ูุงููุชุงุจุงุช ุงูุฌูุงุนูุฉ ููู ูุฑุดุฏููู ุงูุงูุชุฑุงุถููู",
        ),
    ),
]

sub_question_query_engine = SubQuestionQueryEngine.from_defaults(
    query_engine_tools=query_engine_tools,
    use_async=True
)

sub_question_query_engine.update_prompts({'response_synthesizer:text_qa_template': HYPE_ANSWER_GEN_PROMPT_TEMPLATE})
```

```python
from utils import display_prompt_dict

sub_q_prompts = sub_question_query_engine.get_prompts()

display_prompt_dict(sub_q_prompts)
```

```python
sub_question_query_engine.query("ุฅุฒุงู ุฃูุฏุฑ ุฃุจูู ุงูุญุธ ุจุชุงุนูุ ุฅูู ุฃููุงุน ุงูุญุธ ุงููู ูุงุฒู ุฃุณุนู ูููุ ูุฅุฒุงู ุฃูุฏุฑ ุฃูุงู ุงูุญุธ ูุฃููู ุชุนุฑุถู ููุฌุงูุจ ุงูุณูุจู ูุน ุงูุญูุงุธ ุนูู ุงููุฎุงุทุฑุฉ ูู ุงููุนุจุฉุ")
```

## ุชุถูููุงุช ุงููุณุชูุฏุงุช ุงูุงูุชุฑุงุถูุฉ (HyDE)

ุนูู ูุณุชูู ุนุงููุ [HyDE](https://arxiv.org/pdf/2212.10496.pdf) ูู ุชูููุฉ ุชุถููู ุจุชุงุฎุฏ ุงูุงุณุชุนูุงูุงุชุ ุจุชููุฏ ุฅุฌุงุจุฉ ุงูุชุฑุงุถูุฉุ ูุจุนุฏูู ุจุชุถูู ุงููุณุชูุฏ ุงููููุฏ ุฏู ูุจุชุณุชุฎุฏูู ููุซุงู ููุงุฆู.

- ๐ง **ุงููุดููุฉ ุงููู ุจุชุนุงูุฌูุง**: ุจุชุชุนุงูู ูุน ุตุนูุจุฉ ุฅูุดุงุก ุฃูุธูุฉ ุงุณุชุฑุฌุงุน ูุซููุฉ ุจุฏูู ุฃู ุฃูุซูุฉ ูู ุบูุฑ ุนูุงูุงุช ููุงุกูุฉ.

- ๐ **ุงูุทุฑู ุงูุชูููุฏูุฉ**: ุจุชุนุชูุฏ ุนูู ุนูุงูุงุช ุงูููุงุกูุฉ ูุงุณุชุฑุฌุงุน ุงููุณุชูุฏุงุช ุจูุงุกู ุนูู ุงูุชุดุงุจูุงุช ุงูุฏูุงููุฉ.

- ๐ซ **ุชุญุฏู ุจุฏูู ุฃูุซูุฉ**: ุตุนุจ ุฌุฏุงู ุจุฏูู ูุฌููุนุฉ ุจูุงูุงุช ูุจูุฑุฉ ููุชุฏุฑูุจ.

### ุฅูู ูู HyDEุ

ุจุงููุธุฑ ูุงุณุชุนูุงูุ `HyDE` ุจููุฌู ูููุฐุฌ ูุบุฉ ูุชูููุฏ ูุณุชูุฏ ุงูุชุฑุงุถู.

ุงููุณุชูุฏ ุฏู ุจููุชูุท ุฃููุงุท ุงูููุงุกูุฉ ุจุณ ูููู ูุญุชูู ุนูู ุนุฏู ุฏูุฉ ุฃู ุชูุงุตูู ุฎุงุทุฆุฉ.

ุจุนุฏ ุชูููุฏ ุงููุณุชูุฏ ุงูุงูุชุฑุงุถูุ ูุดูุฑ ูุชุนูู ุจุดูู ูุชุจุงูู ุบูุฑ ุฎุงุถุน ููุฅุดุฑุงู ุจูุดูุฑ ุงููุณุชูุฏ ููุชุฌู ุชุถููู.

ุงููุชุฌู ุฏู ุจูุญุฏุฏ ุญู ูู ูุถุงุก ุชุถููู ุงูููููุ ุญูุซ ูุณุชูุฏุงุช ุญููููุฉ ูุดุงุจูุฉ ุจุชุชุณุชุฑุฌุน ุจูุงุกู ุนูู ุชุดุงุจู ุงููุชุฌู.

### ุฅุฒุงู HyDE ุจูุดุชุบูุ

ุงูุนูููุฉ ุจุชุจุฏุฃ ุจุฅุฏุฎุงู ุงุณุชุนูุงู ููููุฐุฌ ุชูููุฏู ูุน ุงูุชุนูููุงุช "ุงูุชุจ ูุณุชูุฏ ุจูุฌุงูุจ ุนูู ุงูุณุคุงู". ุฏู ุจูููุฏ ูุณุชูุฏ ุงูุชุฑุงุถู ุจููุชูุท ุฌููุฑ ุงูููุงุกูุฉ.

- ุจูููุฏ ูุชุฌู ุชุถููู ููุณุชูุฏ "ูููู"

- ูุด ุจูููุฏ ุฃู ูุญุชูู ูุตู ูุนูู ูููุณุชูุฏ

- ุงูุชุถููู ุจุณ ูุญุฌุฒ ูุณุงุญุฉ ูู ููุฑุณ ูุฎุฒู ุงููุชุฌูุงุช

- ูููุด ูุต ูุณุชูุฏ ุงูุชุฑุงุถู ูุงูู ุชูุฏุฑ ุชูุตู ูู ุจุนุฏูู

ุงููุชุฌู ุฏู ุจููุณุชุฎุฏู ููุจุญุซ ุถุฏ ุชุถูููุงุช ุงูููููุ ูุฃูุชุฑ ุงููุณุชูุฏุงุช ุงูุญููููุฉ ุงููุชุดุงุจูุฉ ุจุชุชุณุชุฑุฌุน. ุงูููุฑุฉ ุฅู ุฅุฌุงุจุฉ ุงูุชุฑุงุถูุฉ ูุณุคุงู ุฃูุชุฑ ุชุดุงุจู ุฏูุงูู ูุน ุงูุฅุฌุงุจุฉ ุงูุญููููุฉ ูู ุงูุณุคุงู ููุณู.

**ุนูููุงู ุฏู ูุนูุงู ุฅู ุงูุจุญุซ ุจุชุงุนู ููุณุชุฎุฏู GPT ูุชูููุฏ ุฅุฌุงุจุฉ ุงูุชุฑุงุถูุฉุ ุจุนุฏูู ูุถูููุง ููุณุชุฎุฏููุง ููุจุญุซ**.

ูุฒุงูุง ุฑุฆูุณูุฉ ูู HyDE:

- ุจุฏูู ุฃูุซูุฉุ ูุด ูุญุชุงุฌ ุจูุงูุงุช ูุนููุฉ ุฃู ุถุจุท ุฏููู
- ุจูุคุฏู ุจุดูู ููุงุซู ูููุณุชูุฑุฌุนุงุช ุงููุถุจูุทุฉ ุจุดูู ุฏููู ุนุจุฑ ุงูููุงู/ุงููุบุงุช
- ุจูุคุณุณ ุงูุงุณุชุนูุงู ูู ุจูุงูุงุช ุญููููุฉ ุนุจุฑ ุงููุณุชูุฏุงุช ุงูุงูุชุฑุงุถูุฉ ุงููููุฏุฉ

```python
from llama_index.core.indices.query.query_transform import HyDEQueryTransform
from llama_index.core.query_engine import TransformQueryEngine
```

```python
hyde = HyDEQueryTransform(
    include_original=True,
)

hyde_query_engine = TransformQueryEngine(
    query_engine=index.as_query_engine(), 
    query_transform=hyde,
)
```

```python
display_prompt_dict(hyde_query_engine.get_prompts())
```

```python
response = hyde_query_engine.query(QUERY_STRING)

display(Markdown(f"<b>{response}</b>"))
```

```python
from llama_index.core.query_pipeline import InputComponent
from utils import create_query_pipeline

input_component = InputComponent()

hyde_chain = [input_component, hyde_query_engine]

hyde_query_pipeline = create_query_pipeline(hyde_chain)
```

```python
hyde_query_pipeline.run(input="ุฅูู ุงููู ูุงุฒู ุฃุนููู ูู ุญุงุณุณ ุฅูู ูุด ุจููู ุตุงุฏู ูุน ููุณู ูุจุนุชูุฏ ูุชูุฑ ุนูู ุงูุถูุงูุงุช ุงูุฎุงุฑุฌูุฉุ")
```

</div>
