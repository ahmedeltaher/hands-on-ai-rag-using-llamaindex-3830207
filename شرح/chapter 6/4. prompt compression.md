# ๐ง ุถุบุท ุงูู Prompts ุจุงุณุชุฎุฏุงู LongLLMLingua (ุจุงูุนุฑุจู ุงููุตุฑู)

[**LongLLMLingua**](https://llmlingua.com/) ูู ุทุฑููุฉ ุฐููุฉ ุจุชุญุณูู ุฃุฏุงุก ูููุงุกุฉ ุฃูุธูุฉ ุงูู RAG (Retrieval-Augmented Generation)  
ูุฎุงุตุฉ ูู ุงูุญุงูุงุช ุงููู ูููุง **context ุทููู**ุ ุนู ุทุฑูู ุฅููุง ุชุถุบุท ุงูู prompt ูู ุบูุฑ ูุง ุชุถูุน ุงููุนูู ุงูุฃุณุงุณู.  

ุงูููุฑุฉ ุฅููุง ุจุชุญู ูุดุงูู ุฒู:  
- ูุดููุฉ โุงููู ูู ุงููุต ุจูุถูุนโ ๐ (lost in the middle).  
- ุงูุชูููุฉ ุงูุนุงููุฉ ูู ุงููุนุงูุฌุฉ.  
- ุญุฏูุฏ ุญุฌู ุงูู context ุงููู ุงูููุฏูู ููุฏุฑ ูุณุชูุนุจู.  

๐ธ ุงูุตูุฑุฉ ุงูุชูุถูุญูุฉ ูู ูุดุฑูุน [LongLLMLingua](https://llmlingua.com/)
![LongLLMLingua](https://llmlingua.com/videos/figures/motivation.png)
---

## ๐งฉ ุงูููููุงุช ุงูุฃุณุงุณูุฉ ูู LongLLMLingua

1. **ุถุบุท ุฃููู (Coarse-Grained) ูุงุนู ุจุงูุณุคุงู:**  
   ุจููููู ุงูุนูุงูุฉ ุจูู ุงูุณุคุงู ูุงูุณูุงู (context) ุจูุงุกู ุนูู ูููุงุณ ุงูู perplexity ุงููู ุจูุชุญุณุจ ุจุงููุณุจุฉ ููุณุคุงู.

2. **ุถุบุท ุฏููู (Fine-Grained) ูุงุนู ุจุงูุณุคุงู:**  
   ุจูุณุชุฎุฏู ูููุงุณ ุงุณูู contrastive perplexity ุนุดุงู ูุทูุน ุงููููุงุช ุฃู ุงูุฃุฌุฒุงุก ุงูุฃูู ูู ุงููุตูุต ุงููู ูููุง ุนูุงูุฉ ูุจุงุดุฑุฉ ุจุงูุณุคุงู.

3. **ุชุญูู ุฏููุงูููู ูู ูุณุจุฉ ุงูุถุบุท:**  
   ุจููุณู ุงููุณุชูุฏุงุช ุนูู ุญุณุจ ุฃูููุชูุงุ ููู ูุณุชูุฏ ุจูุงุฎุฏ ูุณุจุฉ ุถุบุท ูุฎุชููุฉ ุจูุงุกู ุนูู ุชุฑุชูุจ ุฃูููุชู ุงููู ุงุชุญุฏุฏ ูู ุงููุฑุญูุฉ ุงูุฃููู.

4. **ุงุณุชุฑุฌุงุน ุงูุชุชุงุจุน (Subsequence Recovery):**  
   ุจููุฏุฑ ูุฑุฌูุน ุงููุต ุงูุฃุตูู ูู ุงุญุชุงุฌุ ุนู ุทุฑูู ุฎุฑูุทุฉ ุจุชุฑุจุท ุจูู ุฃุฌุฒุงุก ุงููุต ุงููุถุบูุท ูุฃุฌุฒุงุก ุงููุต ุงูุฃุตูู.

---

## ๐ ุงููุชุงุฆุฌ ูุงูุชุฌุงุฑุจ

ุชุฌุงุฑุจ LongLLMLingua ุฃุซุจุชุช ุฅููุง ูููู ุชุฒูุฏ ุงูุฃุฏุงุก ูุญุฏ **+21.4 ููุทุฉ** ุนูุฏ ูุนุฏู ุถุบุท **4x** ูู ุณููุงุฑูููุงุช RAGุ  
ูููุงู ุฃุฏูุช ูุชุงุฆุฌ ุฃุญุณู ูู ุทุฑู ุงูู retrieval ูุงูู compression ุงูุชุงููุฉ ูู ุงุฎุชุจุงุฑุงุช ุฒู **LongBench** ู **ZeroScrolls**.

๐ธ ุตูุฑุฉ ุชูุถูุญูุฉ:
![LongLLMLingua](https://llmlingua.com/videos/figures/LLMLingua.png)

---

# โ๏ธ [`LongLLMLinguaPostprocessor`](https://github.com/run-llama/llama_index/blob/main/llama-index-integrations/postprocessor/llama-index-postprocessor-longllmlingua/llama_index/postprocessor/longllmlingua/base.py)

ุงูู `LongLLMLinguaPostprocessor` ูู ููููู (Postprocessor) ุจูุณุชุฎุฏู ุทุฑููุฉ LongLLMLingua  
ุนุดุงู ูุถุบุท ุงููุตูุต (ุฃู ุงูู nodes) ุงููู ุฌุงูุฉ ูู ุงูุงุณุชุฑุฌุงุนุ ููุฎูููุง ุฃูุตุฑ ูุฃูุชุฑ ููุงุกุฉุ  
ูุฏู ุจูุณุงุนุฏ ุนูู ุชูููู ุงูุชูููุฉ ูุชุญุณูู ุงูุฃุฏุงุก.  

---

## โ๏ธ ุงูุจุฑุงููุชุฑุงุช ุงููู ูุญุชุงุฌ ุชุนุฑููุง

- `model_name`: ุงุณู ุงูููุฏูู ุงููู ููุณุชุฎุฏู ูู ุงูุถุบุท (ุงูุงูุชุฑุงุถู `"NousResearch/Llama-2-7b-hf"`).  
- `device_map`: ููุน ุงูุฌูุงุฒ ุงููู ููุดุชุบู ุนููู (ุงูุชุฑุงุถู `"cuda"`).  
- `model_config`: ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ ููููุฏูู (ุงูุชุฑุงุถู: ูุงุถู).  
- `open_api_config`: ุฅุนุฏุงุฏุงุช ูุงุณุชุฎุฏุงู ูุงุฌูุฉ OpenAI (ุงูุชุฑุงุถู: ูุงุถู).  
- `metadata_mode`: ุทุฑููุฉ ุงูุชุนุงูู ูุน ุงูููุชุงุฏุงุชุง ุฃุซูุงุก ุงูู postprocessing (ุงูุชุฑุงุถู `MetadataMode.ALL`).  
- `instruction_str`: ุงููุต ุงููู ุจูุญุฏุฏ ุงูุชุนูููุงุช ุงูุนุงูุฉ ููุถุบุท (ุงูุชุฑุงุถู: `"Given the context, please answer the final question"`).  
- `target_token`: ุนุฏุฏ ุงูุชูููุฒ ุงููุณุชูุฏูุฉ ุจุนุฏ ุงูุถุบุท (ุงูุชุฑุงุถู 300).  
- `rank_method`: ุงูุทุฑููุฉ ุงููู ุจูุณุชุฎุฏููุง ูู ุงูุชุฑุชูุจ ุฃุซูุงุก ุงูุถุบุท (ุงูุชุฑุงุถู `"longllmlingua"`).  
- `additional_compress_kwargs`: ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ ูุนูููุฉ ุงูุถุบุท (ุงูุชุฑุงุถู: ูุงุถู).

---

## ๐ ุงููู ุจูุญุตู ุฌูู ุงูููุฏ (Under the hood)

1. ุจูุณุชุฎุฑุฌ ุงููุญุชูู ูู ูู node ุญุณุจ ุฅุนุฏุงุฏ `metadata_mode`.  
2. ุจููุณูู ุงููุตูุต ุจุงุณุชุฎุฏุงู `\n\n` ุนุดุงู ูุนูู ููุณุช ุฌุฏูุฏุฉ ูู ุงูุณูุงูุงุช.  
3. ุจููุงุฏู ุนูู ุฏุงูุฉ `compress_prompt` ุงููู ุฌูู `PromptCompressor`ุ  
   ูุจูุจุนุชููุง ุงููุตูุต ูุงูุชุนูููุงุช ูุงูุณุคุงู ูุนุฏุฏ ุงูุชูููุฒ ูุทุฑููุฉ ุงูุชุฑุชูุจ ูุงูุฅุนุฏุงุฏุงุช ุงูุฅุถุงููุฉ.  
4. ุงูุฏุงูุฉ ุฏู ุจุชุฑุฌุน ุงูู prompt ุจุนุฏ ุงูุถุบุทุ ูุจููุตููุง ุชุงูู ุจุงุณุชุฎุฏุงู `\n\n`.  
5. ุจูุดูู ุงูุณุคุงู ูุงูุชุนูููุงุช ุงููู ูุงูุช ูู ุงูุฃูู ูุงูุขุฎุฑ.  
6. ุจูุญููู ุงููุตูุต ุงููู ูุถูุช ูู `TextNode` ุฌุฏูุฏุฉุ ูุจููููุง ูู `NodeWithScore`ุ ูุจูุฑุฌุนูุง ููุงุชุฌ ููุงุฆู.

---

## โ๏ธ ููุงุญุธุฉ ูููุฉ

ููุฒุฉ ุงูู **fine-grained compression** (ุงูุถุบุท ุงูุฏููู ุงููุงุนู ุจุงูุณุคุงู) **ูุณู ูุด ูุทุจูุฉ** ูู LlamaIndexุ  
ุงูุถุบุท ุฏูููุชู ุจูุนุชูุฏ ุจุณ ุนูู **ุงูุทุฑููุฉ ุงูุฃูููุฉ (coarse-grained)** ูุทุฑููุฉ ุงูุชุฑุชูุจ ุงููุฎุชุงุฑุฉ.

---

## โ ุงูุฎูุงุตุฉ

**LongLLMLingua** ุจุชุฎูู ุงูููุฏูู ูููู ุฃูุชุฑ ุจููุงู ุฃูู ๐  
ุจุชููู ุงูุชูููุฉุ ุจุชุญุงูุธ ุนูู ุงูุฏูุฉุ ูุจุชุนุงูุฌ ูุดุงูู ุงูู context ุงูุทููู ุจุจุฑุงุนุฉ ๐ฅ
---
# ๐งฉ ุทุฑููุฉ ุงุณุชุฎุฏุงู ุงูู Postprocessor (ุจุงูุนุฑุจู ุงููุตุฑู)

ุงูุทุฑููุฉ ุฏู ููุณ ุงุณุชุฎุฏุงู ุฃู **Node Postprocessor** ุชุงูู ูู LlamaIndexุ  
ูุนูู ุงูุฎุทูุงุช ูุงุญุฏุฉ ุชูุฑูุจูุง ๐  

```python
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader
from llama_index.core.postprocessor import YourPostProcessOfChoice

# ... ุงูุฎุทูุงุช ุงููู ูุจู ูุฏู: ุชุนุฑูู ุงูู index

your_post_processor = YourPostProcessOfChoice(WhateverArgumentsYouNeedToPass)

query_engine = index.as_query_engine(
    ..., # ุจุงูู ุงูุฅุนุฏุงุฏุงุช ุจุชุงุนุช ุงูู query engine
    node_postprocessors = your_post_processor
)

# ูู ุนุงูุฒ ุชุนูู ุงุณุชุนูุงู ูุงุญุฏ ุจุณ
response = query_engine.query("your query")

# ุฃู ูู ุนุงูุฒ ุชุทุจูู ุงูู pipeline ุนูู ูู ุงูุฏุงุชุง ุจุชุงุนุชู
```

ุจุจุณุงุทุฉ:  
ูู ุงููู ุนููู ุชุนุฑู ุงูู postprocessor ุงููู ุนุงูุฒ ุชุณุชุฎุฏููุ  
ูุชุถููู ูู ุฅุนุฏุงุฏุงุช ุงูู query engineุ  
ูุณุงุนุชูุง ููุดุชุบู ุชููุงุฆู ุนูู ูู ุงุณุชุนูุงู ุฃู ูุฌููุนุฉ ุงูุจูุงูุงุช ูููุง ๐ช  
